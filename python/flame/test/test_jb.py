
from __future__ import print_function

import sys
import unittest
import math
import numpy
from numpy import asfarray
from numpy import testing as NT
from numpy.testing import assert_array_almost_equal as assert_aequal

from .. import Machine

from .. import GLPSParser

import os
datadir = os.path.dirname(__file__)

def print_state(S):
  n = 7
  sys.stdout.write('\n')
  for i in range(n):
    sys.stdout.write('[')
    for j in range(n):
      sys.stdout.write('%17.10e' % (S.moment1_env[i, j]))
      if j != n-1: sys.stdout.write(', ')
    if i != n-1:
      sys.stdout.write('],\n')
    else:
      sys.stdout.write(']\n')

class MomentTest(object):
    'Helper for testing moment2 sim'

    def assertConsistent(self, S, msg=None):
        'Check internal consistencies of a State'
        # check "cached" parameters calculated from energy
        self.assertEqual(S.ref_IonW,  S.ref_IonEs+S.ref_IonEk, msg)
        self.assertEqual(S.ref_gamma, S.ref_IonW/S.ref_IonEs, msg)
        self.assertEqual(S.ref_beta,  math.sqrt(1e0-1e0/(S.ref_gamma**2)), msg)
        self.assertEqual(S.ref_bg,    S.ref_beta*S.ref_gamma)

        assert_aequal(S.IonW,  S.IonEs+S.IonEk, err_msg=msg)
        assert_aequal(S.gamma, S.IonW/S.IonEs, err_msg=msg)
        assert_aequal(S.beta,  numpy.sqrt(1e0-1e0/numpy.square(S.gamma)), err_msg=msg)
        assert_aequal(S.bg,    S.beta*S.gamma, err_msg=msg)

        # moment0_env
        W = S.IonQ/S.IonQ.sum()
        W = W.reshape((1,len(W))).repeat(7,axis=0)
        M0env = (S.moment0*W).sum(axis=1)
        assert_aequal(S.moment0_env, M0env, err_msg=msg)

        # moment1_env
        Qs, M0, M0env, M1 = S.IonQ, S.moment0, S.moment0_env, S.moment1
        # using a loop because outer() doesn't understand axis=
        M1env  = numpy.zeros((7,7))
        for i in range(len(Qs)):
            Q = Qs[i]
            m0diff = M0[:,i]-M0env

            M1env[:7,:7] += Q*(M1[...,i]+numpy.outer(m0diff, m0diff))
        M1env /= Qs.sum()

        assert_aequal(S.moment1_env, M1env, err_msg=msg)

        # moment0_rms
        M0rms = numpy.sqrt(numpy.diagonal(S.moment1_env))
        assert_aequal(S.moment0_rms, M0rms, err_msg=msg)

    def assertStateEqual(self, expect, actual, msg=None, decimal=10):
        'Assert that two moment2 State instances are equal'
        for k,v in expect.items():
            #self.assertIn(k, actual, "%s %s missing"%(msg or "",k)) #TODO: make State iterable
            A = getattr(actual, k, None)
            if A is None:
                self.assertTrue(False, "%s %s missing"%(msg or "",k))
            if isinstance(v, numpy.ndarray):
                assert_aequal(v, getattr(actual, k), decimal=decimal, err_msg="%s %s doesn't match"%(msg or "",k))
            else:
                self.assertAlmostEqual(v, getattr(actual, k), places=decimal, msg="%s %s doesn't match"%(msg or "",k))


    def checkPropagate(self, elem, instate, outstate, max=1):
        '''Pass given input state through the named element

        Propagate the same input twice in succession to verify that element(s)
        give the same output.
        The repeat with 'transfer' caching disabled
        '''

        S1 = self.M.allocState(instate, inherit=False)
        S2 = self.M.allocState(instate, inherit=False)

        self.M.propagate(state=S1, start=elem, max=max)
        self.assertConsistent(S1)
        self.M.propagate(state=S2, start=elem, max=max)
        self.assertConsistent(S2)

#        print_state(S1)

        self.assertStateEqual(outstate, S1, 'first pass')
        self.assertStateEqual(outstate, S2, 'second pass') # fails if some Element has a caching problem...

        S1 = self.ICM.allocState(instate, inherit=False)
        S2 = self.ICM.allocState(instate, inherit=False)

        self.ICM.propagate(state=S1, start=elem, max=max)
        self.assertConsistent(S1)
        self.ICM.propagate(state=S2, start=elem, max=max)
        self.assertConsistent(S2)

        self.assertStateEqual(outstate, S1, 'third pass')
        self.assertStateEqual(outstate, S2, 'fourth pass')

class TestToStrl(unittest.TestCase, MomentTest):
    """Strategy is to test the state after the first instance of each element type.

    $ ./tools/run_flame -N <element_name> \
       -F utest,next_elem,moment0,moment1_env,ref_IonQ,ref_IonZ,ref_IonEs,ref_IonEk,ref_phis,IonQ,IonZ,IonEs,IonEk,phis \
       python/flame/test/to_strl.lat
    """
    lattice = 'to_strl.lat'

    def setUp(self):
        with open(os.path.join(datadir, self.lattice), 'rb') as F:
            self.M = Machine(F)
            F.seek(0)
            self.ICM = Machine(F, extra={'skipcache':1.0})

    def test_source(self):
        # S
        self.checkPropagate(0, {}, {
            'next_elem':1,
            'moment0':asfarray([
                [-7.8859999999999998e-04, 7.3126670000000001e-03],
                [1.0837100000000000e-05, 1.4765650000000000e-05],
                [1.3373430000000000e-02, 3.4498490000000001e-03],
                [6.6785340000000002e-06, -7.3976846899999996e-06],
                [-1.8477289999999999e-04, 2.2978860000000000e-02],
                [3.0999499999999998e-04, 2.0601000000000000e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [2.7784895409858517e+00, 2.4291087928314132e-04, -2.8819146985954898e-03, -1.3098890046625701e-05, 5.3594209519492754e-04, -1.7328482801286655e-05, 0.0000000000000000e+00],
                [2.4291087928314132e-04, 4.0675140732215713e-06, 9.1913901431043622e-06, -2.2427664519913498e-08, 3.5190231444234908e-07, -1.1570581361000062e-10, 0.0000000000000000e+00],
                [-2.8819146985954898e-03, 9.1913901431043622e-06, 2.5433968050163540e+00, 2.3922914294383500e-04, -8.7109112520915007e-04, -2.3018796435535812e-06, 0.0000000000000000e+00],
                [-1.3098890046625701e-05, -2.2427664519913498e-08, 2.3922914294383500e-04, 4.6600708350882344e-06, -8.7385463545847361e-07, 1.7247530507817648e-08, 0.0000000000000000e+00],
                [5.3594209519492754e-04, 3.5190231444234908e-07, -8.7109112520915007e-04, -8.7385463545847361e-07, 1.0267518939868806e-03, 1.0056757657182434e-05, 0.0000000000000000e+00],
                [-1.7328482801286655e-05, -1.1570581361000062e-10, -2.3018796435535812e-06, 1.7247530507817648e-08, 1.0056757657182434e-05, 2.6314343481397998e-06, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':5.00000000000000000e+05,
            'ref_phis':0.00000000000000000e+00,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([5.0030999500000000e+05, 5.0206009999999998e+05]),
            'phis':asfarray([-1.8477289999999999e-04, 2.2978860000000000e-02]),
        }, max=1)

    def test_drift(self):
        # drift_1
        self.checkPropagate(0, {}, {
            'next_elem':2,
            'moment0':asfarray([
                [-8.3287999999999938e-06, 8.3757937999999997e-03],
                [1.0837100000000000e-05, 1.4765650000000000e-05],
                [1.3854284448000000e-02, 2.9172157023199998e-03],
                [6.6785340000000002e-06, -7.3976846899999996e-06],
                [-1.3325396829281771e-03, 1.5391130160821812e-02],
                [3.0999499999999998e-04, 2.0601000000000000e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [2.8345547005582050e+00, 5.3577189255509439e-04, -3.2795197045202571e-03, -1.4713681892059471e-05, 6.2542645808289041e-04, -1.7336813619866573e-05, 0.0000000000000000e+00],
                [5.3577189255509439e-04, 4.0675140732215713e-06, 7.5765982976705889e-06, -2.2427664519913498e-08, 3.5228427569447906e-07, -1.1570581361000062e-10, 0.0000000000000000e+00],
                [-3.2795197045202571e-03, 7.5765982976705889e-06, 2.6020036088093637e+00, 5.7475424307018780e-04, -9.3022235763712518e-04, -1.0600574469907109e-06, 0.0000000000000000e+00],
                [-1.4713681892059471e-05, -2.2427664519913498e-08, 5.7475424307018780e-04, 4.6600708350882344e-06, -9.3792991959628860e-07, 1.7247530507817648e-08, 0.0000000000000000e+00],
                [6.2542645808289041e-04, 3.5228427569447906e-07, -9.3022235763712475e-04, -9.3792991959628860e-07, 9.8879108725721874e-04, 3.4841141433569607e-07, 0.0000000000000000e+00],
                [-1.7336813619866573e-05, -1.1570581361000062e-10, -1.0600574469907109e-06, 1.7247530507817648e-08, 3.4841141433569607e-07, 2.6314343481397998e-06, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':5.00000000000000000e+05,
            'ref_phis':3.70896240162486901e+00,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([5.0030999500000000e+05, 5.0206009999999998e+05]),
            'phis':asfarray([3.7076293281508645e+00, 3.7243300943218349e+00]),
        }, max=2)

    def test_rfcav_41(self):
        # ls1_ca01_cav1_d1127  cavtype = "0.041QWR"
        self.checkPropagate(0, {}, {
            'next_elem':4,
            'moment0':asfarray([
                [4.2806343239717116e-03, 1.5129972255810526e-02],
                [1.3170791010251590e-05, 2.6638715098587717e-05],
                [4.0306772693611600e-03, -1.4238677753316846e-02],
                [-1.6893666125019258e-04, -2.0313868893374049e-04],
                [-5.8199847180944175e-03, -2.8171535425187244e-02],
                [1.0937674260139465e-04, 3.2640186251401901e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [4.5737889068082804e+00, 6.0669648277006495e-03, -1.0792259945136952e-02, -3.1759168650761263e-05, 9.1002516920943549e-04, 3.0358922802964227e-05, 0.0000000000000000e+00],
                [6.0669648277006495e-03, 1.0279529425767875e-05, -1.0736164288211990e-05, -4.6551002950065074e-08, 1.0542984435954559e-06, 4.2234819235438213e-08, 0.0000000000000000e+00],
                [-1.0792259945136953e-02, -1.0736164288211994e-05, 4.4609155106701239e+00, 6.1807101898400177e-03, -1.1255393909196713e-03, -6.3650656953149896e-05, 0.0000000000000000e+00],
                [-3.1759168650761263e-05, -4.6551002950065080e-08, 6.1807101898400177e-03, 1.0961176841497697e-05, -1.8057731753519633e-06, -9.3605511068373278e-08, 0.0000000000000000e+00],
                [9.1002516920943570e-04, 1.0542984435954559e-06, -1.1255393909196708e-03, -1.8057731753519637e-06, 1.2760917189525325e-03, -4.6806127720643879e-08, 0.0000000000000000e+00],
                [3.0358922802964227e-05, 4.2234819235438213e-08, -6.3650656953149896e-05, -9.3605511068373278e-08, -4.6806127720648921e-08, 4.2230866648902030e-06, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':5.53528799277067184e+05,
            'ref_phis':2.27471719868534592e+01,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([5.5363817601966858e+05, 5.5679281790220737e+05]),
            'phis':asfarray([2.2741352002135365e+01, 2.2719000451428272e+01]),
        }, max=4)

    def test_solenoid(self):
        # ls1_ca01_sol1_d1131_1
        self.checkPropagate(0, {}, {
            'next_elem':9,
            'moment0':asfarray([
                [-7.5976405161956887e-03, -4.2033140434120323e-03],
                [-3.8191576548473962e-05, -4.3132441823442950e-05],
                [-4.3990633733480659e-02, -7.3762251080284197e-02],
                [-1.1896171910899926e-04, -1.1594740503684112e-04],
                [-7.2514286712388474e-03, -7.0526029188607994e-02],
                [1.0937674260139465e-04, 3.2640186251401901e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [8.0532835805828107e+00, -1.1996773374006241e-03, -1.2076556960799312e-02, 7.8260918480707844e-05, 4.4722636729343661e-04, 7.7455375507305819e-06, 0.0000000000000000e+00],
                [-1.1996773374006249e-03, 1.4386139131164235e-06, 9.9286883345759832e-05, -3.4739396768956866e-09, -2.5932535513055464e-07, -3.8185010164746997e-09, 0.0000000000000000e+00],
                [-1.2076556960799720e-02, 9.9286883345759859e-05, 8.0927099123362876e+00, -9.7902740600577039e-04, -6.4020082997541831e-04, -9.4677007214414072e-05, 0.0000000000000000e+00],
                [7.8260918480708129e-05, -3.4739396768954240e-09, -9.7902740600577104e-04, 1.4431734180561974e-06, -4.0226350811848745e-08, 1.6715286131978529e-08, 0.0000000000000000e+00],
                [4.4722636729343661e-04, -2.5932535513055506e-07, -6.4020082997541809e-04, -4.0226350811849354e-08, 1.9877692143781063e-03, -5.4891187320312006e-05, 0.0000000000000000e+00],
                [7.7455375507305819e-06, -3.8185010164747047e-09, -9.4677007214414072e-05, 1.6715286131978532e-08, -5.4891187320312006e-05, 4.2230866648902030e-06, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':5.53528799277067184e+05,
            'ref_phis':3.72527602222924656e+01,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([5.5363817601966858e+05, 5.5679281790220737e+05]),
            'phis':asfarray([3.7245508581428005e+01, 3.7182047005562815e+01]),
        }, max=9)

    def test_orbtrim(self):
        # ls1_ca01_dch_d1131_2
        self.checkPropagate(0, {}, {
            'next_elem':10,
            'moment0':asfarray([
                [-7.5976405161956887e-03, -4.2033140434120323e-03],
                [-3.8191576548473962e-05, -4.3132441823442950e-05],
                [-4.3990633733480659e-02, -7.3762251080284197e-02],
                [-1.1896171910899926e-04, -1.1594740503684112e-04],
                [-7.2514286712388474e-03, -7.0526029188607994e-02],
                [1.0937674260139465e-04, 3.2640186251401901e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [8.0532835805828107e+00, -1.1996773374006241e-03, -1.2076556960799312e-02, 7.8260918480707844e-05, 4.4722636729343661e-04, 7.7455375507305819e-06, 0.0000000000000000e+00],
                [-1.1996773374006249e-03, 1.4386139131164235e-06, 9.9286883345759832e-05, -3.4739396768956866e-09, -2.5932535513055464e-07, -3.8185010164746997e-09, 0.0000000000000000e+00],
                [-1.2076556960799720e-02, 9.9286883345759859e-05, 8.0927099123362876e+00, -9.7902740600577039e-04, -6.4020082997541831e-04, -9.4677007214414072e-05, 0.0000000000000000e+00],
                [7.8260918480708129e-05, -3.4739396768954240e-09, -9.7902740600577104e-04, 1.4431734180561974e-06, -4.0226350811848745e-08, 1.6715286131978529e-08, 0.0000000000000000e+00],
                [4.4722636729343661e-04, -2.5932535513055506e-07, -6.4020082997541809e-04, -4.0226350811849354e-08, 1.9877692143781063e-03, -5.4891187320312006e-05, 0.0000000000000000e+00],
                [7.7455375507305819e-06, -3.8185010164747047e-09, -9.4677007214414072e-05, 1.6715286131978532e-08, -5.4891187320312006e-05, 4.2230866648902030e-06, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':5.53528799277067184e+05,
            'ref_phis':3.72527602222924656e+01,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([5.5363817601966858e+05, 5.5679281790220737e+05]),
            'phis':asfarray([3.7245508581428005e+01, 3.7182047005562815e+01]),
        }, max=10)

    def test_rfcav_85(self):
        # ls1_cb01_cav1_d1229   cavtype = "0.085QWR"
        self.checkPropagate(0, {}, {
            'next_elem':111,
            'moment0':asfarray([
                [-9.2092486714458882e-02, -9.5109642827502588e-02],
                [-1.3105735293467079e-04, -1.1608711099978083e-04],
                [-1.9484591817550864e-01, -3.8870633931256954e-01],
                [-9.9447130316402624e-04, -1.2403529628537498e-03],
                [-4.0115261066375751e-03, -5.8515727071721813e-02],
                [-3.0021119713783265e-05, 1.2157901312112808e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [3.5741635753180123e+00, 3.9046681137197832e-03, 2.6319553840627891e-01, 1.8850927362115799e-04, -3.3171353330492835e-04, -2.5463826946468120e-05, 0.0000000000000000e+00],
                [3.9046681137197823e-03, 5.3877451153407533e-06, 2.4814486532540096e-04, 1.4838700828255012e-07, -7.1082274147998101e-07, -1.1436375794765219e-08, 0.0000000000000000e+00],
                [2.6319553840627863e-01, 2.4814486532539977e-04, 3.6460516525020283e+00, 3.2992822533457681e-03, 2.4128455790737779e-03, -6.4746360829532031e-05, 0.0000000000000000e+00],
                [1.8850927362115767e-04, 1.4838700828254943e-07, 3.2992822533457712e-03, 4.0807404978435368e-06, 3.2058212902021959e-06, -3.8424368637017261e-08, 0.0000000000000000e+00],
                [-3.3171353330492851e-04, -7.1082274147998122e-07, 2.4128455790737779e-03, 3.2058212902021959e-06, 1.2103473040189110e-03, 1.1651738942551201e-05, 0.0000000000000000e+00],
                [-2.5463826946468174e-05, -1.1436375794765263e-08, -6.4746360829532004e-05, -3.8424368637017215e-08, 1.1651738942551201e-05, 5.4283844065607908e-06, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':1.55668759019720554e+06,
            'ref_phis':4.08528048413382066e+02,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([1.5566575690774918e+06, 1.5579033803284168e+06]),
            'phis':asfarray([4.0852403688727543e+02, 4.0846953268631034e+02]),
        }, max=111)

    def test_quadrupole(self):
        # ls1_bts_qh_d1942
        self.checkPropagate(0, {}, {
            'next_elem':698,
            'moment0':asfarray([
                [1.6518697624310787e+00, 2.7465986883888260e+00],
                [2.5706431384792785e-03, 4.1545963654015137e-03],
                [4.0700288848744337e-01, 7.2041253026041652e-01],
                [1.9919057911409795e-04, -5.7309891259008029e-04],
                [1.3744866376284842e-03, -3.6237441821191506e-02],
                [9.2651004457473753e-04, -1.1550990681052208e-02],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [2.9112671746098280e+00, 4.3634419121115330e-03, 2.2706243347497276e-01, -4.8249852319736053e-04, -1.0221104295852119e-02, -3.5342038702283508e-03, 0.0000000000000000e+00],
                [4.3634419121115330e-03, 6.6698566950406241e-06, 3.4073808752117470e-04, -7.2120764899806356e-07, -1.4794010504038732e-05, -5.0989015093586048e-06, 0.0000000000000000e+00],
                [2.2706243347496924e-01, 3.4073808752116917e-04, 1.3314803328814580e+00, -1.8941670139741432e-03, -2.9206161602146419e-03, -9.8817258354454780e-04, 0.0000000000000000e+00],
                [-4.8249852319735500e-04, -7.2120764899805498e-07, -1.8941670139741421e-03, 3.0434962764341258e-06, 7.1940692080750577e-06, 2.4835020532319970e-06, 0.0000000000000000e+00],
                [-1.0221104295852119e-02, -1.4794010504038732e-05, -2.9206161602146419e-03, 7.1940692080750577e-06, 4.4492782545155570e-04, 8.1421698425609385e-05, 0.0000000000000000e+00],
                [-3.5342038702283508e-03, -5.0989015093586048e-06, -9.8817258354454780e-04, 2.4835020532319970e-06, 8.1421698425609412e-05, 8.1344632397553512e-05, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':1.70909455949932337e+07,
            'ref_phis':1.34071143197342781e+03,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([1.7091872105037808e+07, 1.7079394604312181e+07]),
            'phis':asfarray([1.3407128064371002e+03, 1.3406751909577081e+03]),
        }, max=698)

    def test_sbend(self):
        # fs1_css_dh_d2163_1
        self.checkPropagate(0, {}, {
            'next_elem':831,
            'moment0':asfarray([
                [-1.5865573966477584e+00, -1.7754059343854718e+00],
                [-6.0591045431052245e-04, 8.8237913360813386e-04],
                [-1.0622850793777925e+00, -2.2224145201536563e+00],
                [-7.4661842888722847e-04, -7.8544844580338878e-04],
                [-2.1005970310237474e-03, 2.1435685817553798e-02],
                [-4.7275870454311373e-04, -3.0837818125486376e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [1.7289456693386280e+00, 2.6671946342639790e-04, 1.5225241352473709e-01, -5.5867646567394790e-05, -1.5792405815256813e-03, 3.4344208786011831e-05, 0.0000000000000000e+00],
                [2.6671946342639953e-04, 8.8232084038094344e-07, -5.4049940764587924e-04, -5.3701103992733429e-08, 8.6683922816058201e-06, -9.8867507880591307e-07, 0.0000000000000000e+00],
                [1.5225241352473254e-01, -5.4049940764588108e-04, 3.1222535733063781e+00, 2.9140374831102266e-04, -6.8708500270531605e-03, 7.3814984343682235e-04, 0.0000000000000000e+00],
                [-5.5867646567395028e-05, -5.3701103992733892e-08, 2.9140374831102282e-04, 1.7019622036482040e-07, -6.9809042619394385e-08, 9.5400072773355987e-08, 0.0000000000000000e+00],
                [-1.5792405815256818e-03, 8.6683922816058201e-06, -6.8708500270531648e-03, -6.9809042619395907e-08, 6.3726044042289852e-04, 2.3522916789161689e-04, 0.0000000000000000e+00],
                [3.4344208786011885e-05, -9.8867507880591328e-07, 7.3814984343682040e-04, 9.5400072773355325e-08, 2.3522916789161684e-04, 1.3367141782219324e-04, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':1.38655462184873957e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':1.70904122181179523e+07,
            'ref_phis':1.53615528707064072e+03,
            'IonQ':asfarray([1.0111000000000000e+04, 1.0531000000000000e+04]),
            'IonZ':asfarray([1.3865546218487396e-01, 1.4285714285714285e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([1.7089939459413409e+07, 1.7087328436305404e+07]),
            'phis':asfarray([1.5361531936818110e+03, 1.5361767697235473e+03]),
        }, max=831)

    def test_stripper(self):
        # fs1_strl_strip_d2237_164
        self.checkPropagate(0, {}, {
            'next_elem':900,
            'moment0':asfarray([
                [4.6749567010907561e-01, 4.6749567010907561e-01, 4.6749567010907561e-01, 4.6749567010907561e-01, 4.6749567010907561e-01],
                [1.2113930056098126e-03, 1.2113930056098126e-03, 1.2113930056098126e-03, 1.2113930056098126e-03, 1.2113930056098126e-03],
                [5.2104255904010432e-01, 5.2104255904010432e-01, 5.2104255904010432e-01, 5.2104255904010432e-01, 5.2104255904010432e-01],
                [1.9674837289707500e-03, 1.9674837289707500e-03, 1.9674837289707500e-03, 1.9674837289707500e-03, 1.9674837289707500e-03],
                [1.4005839632760015e-02, 1.4005839632760015e-02, 1.4005839632760015e-02, 1.4005839632760015e-02, 1.4005839632760015e-02],
                [-1.8048333266924292e-03, -1.8048333266924292e-03, -1.8048333266924292e-03, -1.8048333266924292e-03, -1.8048333266924292e-03],
                [1.0000000000000000e+00, 1.0000000000000000e+00, 1.0000000000000000e+00, 1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [3.3653776496589494e-01, -1.6829019681278046e-04, 1.9685479546533488e-01, 1.2774315224989253e-04, 5.5880677618230529e-03, -1.4541808752175616e-03, 0.0000000000000000e+00],
                [-1.6829019681277656e-04, 3.3139287412073686e-06, -3.2022788783932785e-04, -4.6217927894420309e-07, -1.2443479317307242e-05, 3.4478264093524176e-06, 0.0000000000000000e+00],
                [1.9685479546533508e-01, -3.2022788783933034e-04, 6.5957834862296516e-01, 5.9299115331502535e-04, 5.6053942646653206e-03, -1.5054887136346970e-03, 0.0000000000000000e+00],
                [1.2774315224989261e-04, -4.6217927894420722e-07, 5.9299115331502633e-04, 1.3431813343491579e-06, 3.6505921498720145e-06, -1.5118132391627560e-06, 0.0000000000000000e+00],
                [5.5880677618230547e-03, -1.2443479317307242e-05, 5.6053942646653206e-03, 3.6505921498720154e-06, 2.5237357663397599e-04, -6.2637257139908884e-05, 0.0000000000000000e+00],
                [-1.4541808752175618e-03, 3.4478264093524185e-06, -1.5054887136346949e-03, -1.5118132391627497e-06, -6.2637257139909060e-05, 1.5110136285821935e-03, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':3.27731092436974791e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':1.68179689629510567e+07,
            'ref_phis':1.60247306661264474e+03,
            'IonQ':asfarray([7.9002307424607190e-02, 1.5381232421040111e-01, 2.1641311669788110e-01, 2.2004784042027173e-01, 1.6169318952751824e-01]),
            'IonZ':asfarray([3.1932773109243695e-01, 3.2352941176470590e-01, 3.2773109243697479e-01, 3.3193277310924368e-01, 3.3613445378151263e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08, 9.3149432000000000e+08, 9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([1.6816154257186070e+07, 1.6816154257186070e+07, 1.6816154257186070e+07, 1.6816154257186070e+07, 1.6816154257186070e+07]),
            'phis':asfarray([1.6024876226120175e+03, 1.6024876226120175e+03, 1.6024876226120175e+03, 1.6024876226120175e+03, 1.6024876226120175e+03]),
        }, max=900)

    def test_final(self):
        # drift_731
        self.checkPropagate(0, {}, {
            'next_elem':1261,
            'moment0':asfarray([
                [3.2752324903939476e+00, 7.9323199827029345e-01, 2.4542847691389164e-01, 8.5120019023150184e-01, 1.7722507370857767e+00],
                [1.6264522694091343e-05, 2.7789620083513316e-04, 5.9165354820591212e-04, 5.8842006627411172e-04, -2.8797803464812588e-05],
                [4.1342421125781934e+00, 3.3239310318176911e+00, 2.0474921010368550e+00, 4.6558298596067493e-01, -1.1449605800902167e+00],
                [1.7246971381804149e-03, 7.8355459447256503e-04, -1.0064228720065320e-04, -7.5761373176970036e-04, -1.0369379612908958e-03],
                [-9.4985514425141287e-03, -1.5621140160672901e-02, -1.8682976488176017e-02, -1.9398288282542687e-02, -1.8406069778085052e-02],
                [1.2795575776934624e-02, 8.0260431766510005e-07, -6.4433416377305984e-03, -6.5814209195375444e-03, -4.9201205158233639e-04],
                [1.0000000000000000e+00, 1.0000000000000000e+00, 1.0000000000000000e+00, 1.0000000000000000e+00, 1.0000000000000000e+00],
            ]),
            'moment1_env':asfarray([
                [4.3986359286685692e+00, -1.0616512564411207e-04, 1.4411487760532447e-02, -3.0296029746518797e-04, -1.8869234689389777e-02, 2.0393230824193947e-03, 0.0000000000000000e+00],
                [-1.0616512564410646e-04, 4.9570504270871294e-07, 3.0901853375970802e-04, 3.9626728990002779e-08, 8.2462663320219011e-07, -9.8476930605853497e-07, 0.0000000000000000e+00],
                [1.4411487760546743e-02, 3.0901853375970933e-04, 6.5727958189542557e+00, 2.7540054815483423e-03, 7.7069472865761175e-03, 5.2455475777312436e-03, 0.0000000000000000e+00],
                [-3.0296029746518401e-04, 3.9626728990002541e-08, 2.7540054815483623e-03, 1.8784036222075744e-06, 9.3079770177480779e-06, 4.3760834645229290e-06, 0.0000000000000000e+00],
                [-1.8869234689389842e-02, 8.2462663320217804e-07, 7.7069472865760550e-03, 9.3079770177480830e-06, 5.0800488893909404e-04, 5.1394909319065743e-04, 0.0000000000000000e+00],
                [2.0393230824193782e-03, -9.8476930605853349e-07, 5.2455475777311708e-03, 4.3760834645229281e-06, 5.1394909319065754e-04, 1.3051561248199675e-03, 0.0000000000000000e+00],
                [0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00, 0.0000000000000000e+00],
            ]),
            'ref_IonQ':1.01110000000000000e+04,
            'ref_IonZ':3.27731092436974791e-01,
            'ref_IonEs':9.31494320000000000e+08,
            'ref_IonEk':1.68169511919587851e+07,
            'ref_phis':2.02365128719019913e+03,
            'IonQ':asfarray([7.9002307424607190e-02, 1.5381232421040111e-01, 2.1641311669788110e-01, 2.2004784042027173e-01, 1.6169318952751824e-01]),
            'IonZ':asfarray([3.1932773109243695e-01, 3.2352941176470590e-01, 3.2773109243697479e-01, 3.3193277310924368e-01, 3.3613445378151263e-01]),
            'IonEs':asfarray([9.3149432000000000e+08, 9.3149432000000000e+08, 9.3149432000000000e+08, 9.3149432000000000e+08, 9.3149432000000000e+08]),
            'IonEk':asfarray([1.6829746767735720e+07, 1.6816951994563103e+07, 1.6810507850321054e+07, 1.6810369771039248e+07, 1.6816459179907203e+07]),
            'phis':asfarray([2.0236417753279932e+03, 2.0236356660500376e+03, 2.0236326008320109e+03, 2.0236318853736768e+03, 2.0236328811007140e+03]),
        }, max=1261)


class testComplete(unittest.TestCase):
  'Tests of entire lattice files'

  def test_LS1_cs0(self):
    "Propagate charge state 0 through LS1."
    PS_X = 0; PS_PX = 1; PS_Y = 2; PS_PY = 3; PS_S = 4; PS_PS = 5

    MeVtoeV = 1e6

    def sqr(a): return a*a;

    P = GLPSParser()

    file_name = 'LS1.lat'

    with open(os.path.join(datadir, file_name), 'rb') as inf:
      M = Machine(inf, extra={'cstate':0})

      S = M.allocState({})
      M.propagate(S, 0, 1)

      self.assertAlmostEqual(S.real_IonZ, 0.13865546218487396, 14)
      self.assertAlmostEqual(S.real_IonEs, 931494320.0, 14)

      self.assertAlmostEqual(S.ref_IonZ, 0.13865546218487396, 14)
      self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 14)
      self.assertAlmostEqual(S.ref_IonEk, 500000.0, 14)

      def checkConsist(self, S, P='real'):
          self.assertEqual(getattr(S, P+'_IonW')    , getattr(S, P+'_IonEs')+getattr(S, P+'_IonEk'))
          self.assertEqual(getattr(S, P+'_gamma')   , getattr(S, P+'_IonW')/getattr(S, P+'_IonEs'))
          self.assertEqual(getattr(S, P+'_beta')    , math.sqrt(1e0-1e0/sqr(getattr(S, P+'_gamma'))))
          self.assertEqual(getattr(S, P+'_bg')      , getattr(S, P+'_beta')*getattr(S, P+'_gamma'))

      checkConsist(self, S, 'real')
      checkConsist(self, S, 'ref')
      self.assertAlmostEqual(S.ref_phis,  0.0, 14)

      assert_aequal(S.moment0_env,
        [-7.88600000e-04, 1.08371000e-05, 1.33734300e-02, 6.67853400e-06, -1.84772900e-04, 3.09995000e-04, 1.00000000e+00],
      decimal=8)

      assert_aequal(S.moment1_env, [
        [ 2.7630945017e+00, -4.2824733660e-04,  1.5817856917e-02,  2.1559419100e-05,  1.8638050602e-04, -2.9939448697e-05,  0.0000000000e+00],
        [-4.2824733660e-04,  3.8494660679e-06, -1.3838544007e-06, -1.8540987783e-08,  1.0677795224e-07,  5.2856401597e-09,  0.0000000000e+00],
        [ 1.5817856917e-02, -1.3838544007e-06,  2.3625122600e+00, -6.6932045998e-04, -5.8009993858e-04,  6.7165153406e-06,  0.0000000000e+00],
        [ 2.1559419100e-05, -1.8540987783e-08, -6.6932045998e-04,  4.8971138918e-06, -5.0161488223e-07,  5.5748422180e-08,  0.0000000000e+00],
        [ 1.8638050602e-04,  1.0677795224e-07, -5.8009993858e-04, -5.0161488223e-07,  6.7168718453e-04, -1.2322334153e-05,  0.0000000000e+00],
        [-2.9939448697e-05,  5.2856401597e-09,  6.7165153406e-06,  5.5748422180e-08, -1.2322334153e-05,  1.9952466899e-06,  0.0000000000e+00],
        [ 0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00]
      ], decimal=8)

      M.propagate(S, 1, len(M))

      self.assertAlmostEqual(S.real_IonZ, 0.13865546218487396, 12)
      self.assertAlmostEqual(S.real_IonEs, 931494320.0, 12)

      self.assertAlmostEqual(S.ref_IonZ, 0.13865546218487396, 12)
      self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 12)

      checkConsist(self, S, 'real')
      self.assertAlmostEqual(S.real_phis,  1532.1994551432952, 14)
      self.assertAlmostEqual(S.real_IonEk,  17089939.45941341, 14)

      checkConsist(self, S, 'ref')
      self.assertAlmostEqual(S.ref_bg,  0.19243502172784563, 14)
      self.assertAlmostEqual(S.ref_phis,  1532.2018533339335, 14)
      self.assertAlmostEqual(S.ref_IonEk,  17090412.218117952, 14)

      assert_aequal(S.moment0_env,
        [-1.31487198e+00, -6.14116226e-04, -7.31682439e-01, -7.46618429e-04, -2.39819002e-03, -4.72758705e-04,  1.00000000e+00],
        decimal=8)

      assert_aequal(S.moment1_env, [
        [ 1.28985466e+00,  5.25768610e-04, -1.07818343e-01, -8.75275442e-05, -1.74466591e-04, -4.89638797e-05,  0.00000000e+00],
        [ 5.25768610e-04,  4.63230951e-07, -1.87620874e-04, -4.61354166e-08,  4.10553482e-08,  1.86305659e-08,  0.00000000e+00],
        [-1.07818343e-01, -1.87620874e-04,  2.54172968e+00,  4.50707865e-04,  2.29903897e-04,  1.14226041e-04,  0.00000000e+00],
        [-8.75275442e-05, -4.61354166e-08,  4.50707865e-04,  2.09807522e-07,  1.67123574e-07,  7.00281218e-08,  0.00000000e+00],
        [-1.74466591e-04,  4.10553482e-08,  2.29903897e-04,  1.67123574e-07,  3.45700733e-04,  1.29370100e-04,  0.00000000e+00],
        [-4.89638797e-05,  1.86305659e-08,  1.14226041e-04,  7.00281218e-08,  1.29370100e-04,  5.18511035e-05,  0.00000000e+00],
        [ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00]
      ], decimal=8)


  def test_LS1_cs1(self):
      "Propagate charge state 1 through LS1."
      PS_X = 0; PS_PX = 1; PS_Y = 2; PS_PY = 3; PS_S = 4; PS_PS = 5

      MeVtoeV = 1e6

      def sqr(a): return a*a;

      P = GLPSParser()

      file_name = 'LS1.lat'

      with open(os.path.join(datadir, file_name), 'rb') as inf:
        M = Machine(inf, extra={'cstate':1})

        S = M.allocState({})
        M.propagate(S, 0, 1)

        self.assertAlmostEqual(S.real_IonZ, 0.14285714285714285, 14)
        self.assertAlmostEqual(S.real_IonEs, 931494320.0, 14)

        self.assertAlmostEqual(S.ref_IonZ, 0.13865546218487396, 14)
        self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 14)
        self.assertAlmostEqual(S.ref_IonEk, 500000.0, 14)

        def checkConsist(self, S, P='real'):
            self.assertEqual(getattr(S, P+'_IonW')    , getattr(S, P+'_IonEs')+getattr(S, P+'_IonEk'))
            self.assertEqual(getattr(S, P+'_gamma')   , getattr(S, P+'_IonW')/getattr(S, P+'_IonEs'))
            self.assertEqual(getattr(S, P+'_beta')    , math.sqrt(1e0-1e0/sqr(getattr(S, P+'_gamma'))))
            self.assertEqual(getattr(S, P+'_bg')      , getattr(S, P+'_beta')*getattr(S, P+'_gamma'))

        checkConsist(self, S, 'real')
        checkConsist(self, S, 'ref')
        self.assertAlmostEqual(S.ref_phis,  0.0, 14)

        assert_aequal(S.moment0_env,
          [7.31266700e-03,   1.47656500e-05,   3.44984900e-03, -7.39768469e-06,   2.29788600e-02,   2.06010000e-03, 1.00000000e+00],
        decimal=8)

        assert_aequal(S.moment1_env, [
          [ 2.7932384438e+00,  8.8728620447e-04, -2.0796518392e-02, -4.6319090287e-05,  7.7964408668e-04, -1.2165264951e-05,  0.0000000000e+00],
          [ 8.8728620447e-04,  4.2768582732e-06,  1.9363966143e-05, -2.6132244852e-08,  5.4267659715e-07, -8.6693752768e-09,  0.0000000000e+00],
          [-2.0796518392e-02,  1.9363966143e-05,  2.7170190301e+00,  1.1114753191e-03, -1.0378823624e-03, -2.4536315081e-06,  0.0000000000e+00],
          [-4.6319090287e-05, -2.6132244852e-08,  1.1114753191e-03,  4.4323845352e-06, -1.0715375602e-06, -7.6510496305e-09,  0.0000000000e+00],
          [ 7.7964408668e-04,  5.4267659715e-07, -1.0378823624e-03, -1.0715375602e-06,  1.1048374735e-03,  1.1686344655e-05,  0.0000000000e+00],
          [-1.2165264951e-05, -8.6693752768e-09, -2.4536315081e-06, -7.6510496305e-09,  1.1686344655e-05,  1.7419755309e-06,  0.0000000000e+00],
          [ 0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00]
        ], decimal=8)

        M.propagate(S, 1, len(M))

        self.assertAlmostEqual(S.real_IonZ, 0.14285714285714285, 12)
        self.assertAlmostEqual(S.real_IonEs, 931494320.0, 12)

        self.assertAlmostEqual(S.ref_IonZ, 0.13865546218487396, 12)
        self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 12)

        checkConsist(self, S, 'real')
        self.assertAlmostEqual(S.real_phis,  1532.222661902655, 14)
        self.assertAlmostEqual(S.real_IonEk,  17087328.436305404, 14)

        checkConsist(self, S, 'ref')
        self.assertAlmostEqual(S.ref_bg,  0.19243502172784563, 14)
        self.assertAlmostEqual(S.ref_phis,  1532.2018533339335, 14)
        self.assertAlmostEqual(S.ref_IonEk,  17090412.218117952, 14)

        assert_aequal(S.moment0_env,
          [-1.9433786002e+00, 3.4278187693e-04, -1.8746179484e+00, -7.8544844580e-04, 2.0808595165e-02, -3.0837818125e-03, 1.0000000000e+00],
          decimal=8)

        assert_aequal(S.moment1_env, [
            [1.6617407565e+00, -1.1561293961e-04, 4.2375967312e-01, 5.2156789327e-06, -3.2654073339e-04, -1.6658632146e-04, 0.0000000000e+00],
            [-1.1561293961e-04, 2.0635559854e-07, 1.7108084373e-06, -3.3149516396e-08, 1.5559377703e-07, 8.0035719827e-08, 0.0000000000e+00],
            [4.2375967312e-01, 1.7108084373e-06, 2.5993321057e+00, -3.1005696288e-05, -4.2384040453e-04, -2.0736703233e-04, 0.0000000000e+00],
            [5.2156789327e-06, -3.3149516396e-08, -3.1005696288e-05, 1.3142616035e-07, 1.4856230934e-07, 7.0098541878e-08, 0.0000000000e+00],
            [-3.2654073339e-04, 1.5559377703e-07, -4.2384040453e-04, 1.4856230934e-07, 7.5949774421e-04, 3.9605913591e-04, 0.0000000000e+00],
            [-1.6658632146e-04, 8.0035719827e-08, -2.0736703233e-04, 7.0098541878e-08, 3.9605913591e-04, 2.0888918966e-04, 0.0000000000e+00],
            [0.0000000000e+00, 0.0000000000e+00, 0.0000000000e+00, 0.0000000000e+00, 0.0000000000e+00, 0.0000000000e+00, 0.0000000000e+00],
        ], decimal=8)


  def test_through_stripper(self):
      "Propagate charge states 0-1 to Charge Stripper, and 0-4 afterwards"
      PS_X = 0; PS_PX = 1; PS_Y = 2; PS_PY = 3; PS_S = 4; PS_PS = 5

      MeVtoeV = 1e6

      def sqr(a): return a*a;

      P = GLPSParser()

      file_name = 'to_strl.lat'

      with open(os.path.join(datadir, file_name), 'rb') as inf:
        M = Machine(inf)

        S = M.allocState({})
        M.propagate(S, 0, 1)

        self.assertAlmostEqual(S.real_IonZ, 0.13865546218487396, 14)
        self.assertAlmostEqual(S.real_IonEs, 931494320.0, 14)
        self.assertAlmostEqual(S.real_IonEk, 500309.99500000, 14)

        self.assertAlmostEqual(S.ref_IonZ, 0.13865546218487396, 14)
        self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 14)
        self.assertAlmostEqual(S.ref_IonEk, 500000.0, 14)

        def checkConsist(self, S, P='real'):
          self.assertEqual(getattr(S, P+'_IonW')    , getattr(S, P+'_IonEs')+getattr(S, P+'_IonEk'))
          self.assertEqual(getattr(S, P+'_gamma')   , getattr(S, P+'_IonW')/getattr(S, P+'_IonEs'))
          self.assertEqual(getattr(S, P+'_beta')    , math.sqrt(1e0-1e0/sqr(getattr(S, P+'_gamma'))))
          self.assertEqual(getattr(S, P+'_bg')      , getattr(S, P+'_beta')*getattr(S, P+'_gamma'))

        checkConsist(self, S, 'real')
        checkConsist(self, S, 'ref')
        self.assertAlmostEqual(S.ref_phis,  0.0, 14)

        assert_aequal(S.moment0_env,
          [3.3444511955e-03,1.2841341839e-05,8.3106826155e-03,-5.0277881002e-07,1.1632697213e-02,1.2028520756e-03,1.0000000000e+00],
        decimal=8)

        assert_aequal(S.moment1_env, [
          [ 2.7784895410e+00,  2.4291087928e-04, -2.8819146986e-03, -1.3098890047e-05,  5.3594209519e-04, -1.7328482801e-05,  0.0000000000e+00],
          [ 2.4291087928e-04,  4.0675140732e-06,  9.1913901431e-06, -2.2427664520e-08,  3.5190231444e-07, -1.1570581361e-10,  0.0000000000e+00],
          [-2.8819146986e-03,  9.1913901431e-06,  2.5433968050e+00,  2.3922914294e-04, -8.7109112521e-04, -2.3018796436e-06,  0.0000000000e+00],
          [-1.3098890047e-05, -2.2427664520e-08,  2.3922914294e-04,  4.6600708351e-06, -8.7385463546e-07,  1.7247530508e-08,  0.0000000000e+00],
          [ 5.3594209519e-04,  3.5190231444e-07, -8.7109112521e-04, -8.7385463546e-07,  1.0267518940e-03,  1.0056757657e-05,  0.0000000000e+00],
          [-1.7328482801e-05, -1.1570581361e-10, -2.3018796436e-06,  1.7247530508e-08,  1.0056757657e-05,  2.6314343481e-06,  0.0000000000e+00],
          [ 0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00]
        ], decimal=8)

        M.propagate(S, 1, len(M))

        self.assertAlmostEqual(S.real_IonZ, 0.31932773109243695, 12)
        self.assertAlmostEqual(S.real_IonEs, 931494320.0, 12)

        self.assertAlmostEqual(S.ref_IonZ, 0.3277310924369748, 12)
        self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 12)

        checkConsist(self, S, 'real')
        self.assertAlmostEqual(S.real_phis,  2023.6417753279932, 14)
        self.assertAlmostEqual(S.real_IonEk,  16829746.76773572, 14)

        checkConsist(self, S, 'ref')
        self.assertAlmostEqual(S.ref_phis,  2023.6512871901991, 14)
        self.assertAlmostEqual(S.ref_IonEk,  16816951.191958785, 14)

        assert_aequal(S.moment0_env,
            [1.0923868437e+00,3.5728723827e-04,1.4420500562e+00,-1.1959772575e-04,-1.7378583261e-02,-2.2999692554e-03,1.0000000000e+00],
          decimal=8)

        assert_aequal(S.moment1_env, [
          [ 4.3986359287e+00, -1.0616512564e-04,  1.4411487761e-02, -3.0296029747e-04, -1.8869234689e-02,  2.0393230824e-03,  0.0000000000e+00],
          [-1.0616512564e-04,  4.9570504271e-07,  3.0901853376e-04,  3.9626728990e-08,  8.2462663320e-07, -9.8476930606e-07,  0.0000000000e+00],
          [ 1.4411487761e-02,  3.0901853376e-04,  6.5727958190e+00,  2.7540054815e-03,  7.7069472866e-03,  5.2455475777e-03,  0.0000000000e+00],
          [-3.0296029747e-04,  3.9626728990e-08,  2.7540054815e-03,  1.8784036222e-06,  9.3079770177e-06,  4.3760834645e-06,  0.0000000000e+00],
          [-1.8869234689e-02,  8.2462663320e-07,  7.7069472866e-03,  9.3079770177e-06,  5.0800488894e-04,  5.1394909319e-04,  0.0000000000e+00],
          [ 2.0393230824e-03, -9.8476930606e-07,  5.2455475777e-03,  4.3760834645e-06,  5.1394909319e-04,  1.3051561248e-03,  0.0000000000e+00],
          [ 0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00]
        ], decimal=8)


  def test_to_end(self):
      "Propagate charge states 0-1 to Charge Stripper, and 0-4 to end of structure with mis-alignments."
      PS_X = 0; PS_PX = 1; PS_Y = 2; PS_PY = 3; PS_S = 4; PS_PS = 5

      MeVtoeV = 1e6

      def sqr(a): return a*a;

      P = GLPSParser()

      file_name = 'to_chg_str_err.lat'

      with open(os.path.join(datadir, file_name), 'rb') as inf:
        M = Machine(inf)

        S = M.allocState({})
        M.propagate(S, 0, 1)

        self.assertAlmostEqual(S.real_IonZ, 0.13865546218487396, 14)
        self.assertAlmostEqual(S.real_IonEs, 931494320.0, 14)
        self.assertAlmostEqual(S.real_IonEk, 500309.99500000, 14)

        self.assertAlmostEqual(S.ref_IonZ, 0.13865546218487396, 14)
        self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 14)
        self.assertAlmostEqual(S.ref_IonEk, 500000.0, 14)

        def checkConsist(self, S, P='real'):
          self.assertEqual(getattr(S, P+'_IonW')    , getattr(S, P+'_IonEs')+getattr(S, P+'_IonEk'))
          self.assertEqual(getattr(S, P+'_gamma')   , getattr(S, P+'_IonW')/getattr(S, P+'_IonEs'))
          self.assertEqual(getattr(S, P+'_beta')    , math.sqrt(1e0-1e0/sqr(getattr(S, P+'_gamma'))))
          self.assertEqual(getattr(S, P+'_bg')      , getattr(S, P+'_beta')*getattr(S, P+'_gamma'))

        checkConsist(self, S, 'real')
        checkConsist(self, S, 'ref')
        self.assertAlmostEqual(S.ref_phis,  0.0, 14)

        assert_aequal(S.moment0_env,
          [3.3444511955e-03,1.2841341839e-05,8.3106826155e-03,-5.0277881002e-07,1.1632697213e-02,1.2028520756e-03,1.0000000000e+00],
        decimal=8)

        assert_aequal(S.moment1_env, [
            [ 2.7784895410e+00,  2.4291087928e-04, -2.8819146986e-03, -1.3098890047e-05,  5.3594209519e-04, -1.7328482801e-05,  0.0000000000e+00],
            [ 2.4291087928e-04,  4.0675140732e-06,  9.1913901431e-06, -2.2427664520e-08,  3.5190231444e-07, -1.1570581361e-10,  0.0000000000e+00],
            [-2.8819146986e-03,  9.1913901431e-06,  2.5433968050e+00,  2.3922914294e-04, -8.7109112521e-04, -2.3018796436e-06,  0.0000000000e+00],
            [-1.3098890047e-05, -2.2427664520e-08,  2.3922914294e-04,  4.6600708351e-06, -8.7385463546e-07,  1.7247530508e-08,  0.0000000000e+00],
            [ 5.3594209519e-04,  3.5190231444e-07, -8.7109112521e-04, -8.7385463546e-07,  1.0267518940e-03,  1.0056757657e-05,  0.0000000000e+00],
            [-1.7328482801e-05, -1.1570581361e-10, -2.3018796436e-06,  1.7247530508e-08,  1.0056757657e-05,  2.6314343481e-06,  0.0000000000e+00],
            [ 0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00]
        ], decimal=8)

        M.propagate(S, 1, len(M))

        self.assertAlmostEqual(S.real_IonZ, 0.319327731092, 12)
        self.assertAlmostEqual(S.real_IonEs, 931494320.0, 12)

        self.assertAlmostEqual(S.ref_IonZ, 0.327731092437, 12)
        self.assertAlmostEqual(S.ref_IonEs, 931494320.0, 12)

        checkConsist(self, S, 'real')
        self.assertAlmostEqual(S.real_phis,  2023.640231990024, 12)
        self.assertAlmostEqual(S.real_IonEk,  16827008.470873594284, 12)

        checkConsist(self, S, 'ref')
        self.assertAlmostEqual(S.ref_phis,  2023.651314326443, 12)
        self.assertAlmostEqual(S.ref_IonEk,  16816951.191958785057, 12)

        assert_aequal(S.moment0_env,
            [6.0625179097e+00,9.3784744367e-04,1.0685277284e+00,-2.2663813468e-03,-1.8084741428e-02,-2.2133294018e-03,1.0000000000e+00],
          decimal=8)

        assert_aequal(S.moment1_env, [
          [ 1.3441952388e+01,  4.1493100647e-03,  3.5581817834e+01,  1.9146148774e-02,  3.7791956156e-03, -7.2604434996e-03,  0.0000000000e+00],
          [ 4.1493100647e-03,  4.5228253867e-06,  5.0067911136e-03,  1.1327665007e-05, -2.6303767247e-06, -1.4406372295e-05,  0.0000000000e+00],
          [ 3.5581817834e+01,  5.0067911136e-03,  1.4559022426e+02,  5.0499060613e-02,  2.0825579323e-02,  6.3711134701e-03,  0.0000000000e+00],
          [ 1.9146148774e-02,  1.1327665007e-05,  5.0499060613e-02,  4.5027125399e-05, -4.5961351604e-06, -3.5715788183e-05,  0.0000000000e+00],
          [ 3.7791956156e-03, -2.6303767247e-06,  2.0825579323e-02, -4.5961351604e-06,  2.2832789853e-04,  4.9093691735e-04,  0.0000000000e+00],
          [-7.2604434996e-03, -1.4406372295e-05,  6.3711134701e-03, -3.5715788183e-05,  4.9093691735e-04,  1.3348204463e-03,  0.0000000000e+00],
          [ 0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00,  0.0000000000e+00]
        ], decimal=8)
